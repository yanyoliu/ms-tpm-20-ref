name: Build ms-tpm-20-ref (Windows x86_64 - MSYS2)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows-msys2:
    runs-on: windows-latest
    name: Build on Windows (MSYS2 / x86_64)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Install MSYS2 (base). This prepares MSYS2 on the runner.
      - name: Setup MSYS2 (install base)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false

      # Run pacman and other MSYS2 commands inside MSYS2 shell.
      # Use the 'msys2' shell so pacman is available.
      - name: Update MSYS2 and install packages (ensure autoconf etc)
        # run inside MSYS2 MINGW64 shell
        shell: msys2 { msystem: MINGW64 }
        run: |
          set -euo pipefail
          # update package DB and core system
          pacman -Syuu --noconfirm || true
          pacman -Su --noconfirm || true

          pacman -S --noconfirm --needed \
            autoconf \
            automake \
            libtool \
            autoconf-archive \
            m4 \
            make \
            pkg-config \
            gawk \
            mingw-w64-x86_64-toolchain \
            mingw-w64-x86_64-openssl

          echo "==== VERSIONS ===="
          uname -a
          gcc --version || true
          autoconf --version || true
          automake --version || true
          pacman -Qi autoconf || true

      - name: Build (autoreconf + configure + make) in MINGW64
        # also run inside MSYS2 MINGW64 shell
        shell: msys2 { msystem: MINGW64 }
        run: |
          set -euo pipefail
          cd TPMCmd
          rm -rf autom4te.cache aclocal.m4 configure config.status config.log
          autoreconf -fi
          ./configure --host=x86_64-w64-mingw32 --prefix=/mingw64
          make -j$(nproc)

      - name: Collect binaries
        shell: msys2 { msystem: MINGW64 }
        run: |
          mkdir -p out
          find . -type f -iname "*.exe" -print0 | xargs -0 -I{} cp -v {} out/ || true
          ls -l out || true

      - name: Upload built artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ms-tpm-20-ref-windows-x86_64
          path: out